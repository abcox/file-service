# CI/CD Pipeline Setup Guide

This guide will help you set up a complete CI/CD pipeline from your GitHub repository to Azure App Service.

## ðŸŽ¯ Overview

Your CI/CD pipeline will:
1. **Lint** the code for quality issues
2. **Test** with pre-build smoke tests (fail fast)
3. **Build** your NestJS application
4. **Deploy** to Azure App Service or Azure Container Instances
5. **Verify** with post-deployment smoke tests

## ðŸ§ª Automated Testing in Pipeline

The pipeline includes automated testing at two stages:

### Pre-Build Smoke Tests
Runs **before** deployment to catch issues early:
- Builds the application
- Starts server locally in CI environment
- Runs `npm run test:smoke`
- **Fails the pipeline** if tests don't pass (prevents bad deploys)

### Post-Deployment Smoke Tests
Runs **after** deployment to validate the live app:
- Waits for deployment to be ready
- Tests `/health`, `/`, `/api`, `/api/diagnostic/services`
- Validates the deployment actually works

### Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Lint      â”‚ --> â”‚ Pre-build   â”‚ --> â”‚   Build     â”‚
â”‚             â”‚     â”‚ Smoke Tests â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                    â”‚
                          â”‚ fail early         â”‚
                          v                    v
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   STOP    â”‚       â”‚   Deploy    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              v
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚ Post-deploy â”‚
                                       â”‚ Smoke Tests â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“‹ Prerequisites

- âœ… Azure resources deployed (completed via `deploy.ps1`)
- âœ… GitHub repository with your code
- âœ… Publish profile from Azure (generated by deployment script)

## ðŸ”§ Step 1: Add GitHub Secrets

### 1.1 Get the Publish Profile

The deployment script generated a file called `publish-profile-vorba-file-service.xml`. You need to add this to GitHub Secrets.

1. Open the file `publish-profile-vorba-file-service.xml` in your `file-service/scripts/` directory
2. Copy the entire content of the file

### 1.2 Add to GitHub Secrets

1. Go to your GitHub repository
2. Click **Settings** â†’ **Secrets and variables** â†’ **Actions**
3. Click **New repository secret**
4. Name: `AZURE_WEBAPP_PUBLISH_PROFILE`
5. Value: Paste the entire content of the publish profile XML file
6. Click **Add secret**

## ðŸ”„ Step 2: Choose Your Workflow

You have two workflow options:

### Option A: Simple Workflow (Recommended for starting)
- File: `.github/workflows/azure-deploy.yml`
- Basic build and deploy
- Good for getting started quickly

### Option B: Comprehensive Workflow
- File: `.github/workflows/azure-deploy-comprehensive.yml`
- Includes linting, health checks, and deployment verification
- Better for production environments

## ðŸš€ Step 3: Test the Pipeline

### 3.1 Manual Trigger (Optional)
1. Go to **Actions** tab in your GitHub repository
2. Select your workflow
3. Click **Run workflow**
4. Choose branch and click **Run workflow**

### 3.2 Automatic Trigger
1. Make a small change to your code
2. Commit and push to `main` or `develop` branch
3. Watch the workflow run in the **Actions** tab

## ðŸ“Š Step 4: Monitor Your Deployment

### 4.1 GitHub Actions
- Go to **Actions** tab to see workflow runs
- Click on any run to see detailed logs
- Check the deployment summary at the end

### 4.2 Azure Portal
- Go to [Azure Portal](https://portal.azure.com)
- Navigate to your App Service: `vorba-file-service`
- Check **Deployment Center** for deployment history
- Monitor **Log stream** for application logs

### 4.3 Health Check
- Visit: `https://vorba-file-service.azurewebsites.net/health`
- Should return: `{"status":"ok","timestamp":"...","service":"vorba-file-service","version":"1.0.0"}`

## ðŸ” Step 5: Troubleshooting

### Common Issues

#### 1. Build Failures
- Check Node.js version compatibility
- Verify all dependencies are in `package.json`
- Check for TypeScript compilation errors

#### 2. Deployment Failures
- Verify the publish profile secret is correct
- Check Azure App Service is running
- Ensure the app name matches: `vorba-file-service`

#### 3. Health Check Failures
- Check application logs in Azure Portal
- Verify environment variables are set correctly
- Check Key Vault access permissions

#### 4. Pre-build Smoke Test Failures
- Tests run against a local server in the CI environment
- Check if server started correctly (look for startup logs)
- Verify test endpoints exist and are accessible
- Run `npm run test:smoke` locally to reproduce

#### 5. Post-deployment Smoke Test Failures
- Deployment may still be starting up (increase wait time)
- Check Azure App Service logs for startup errors
- Verify DNS/URL is correct
- Check for configuration differences between environments

### Debug Commands

```bash
# Check Azure App Service logs
az webapp log tail --name vorba-file-service --resource-group vorba-file-service-rg

# Check deployment status
az webapp deployment list --name vorba-file-service --resource-group vorba-file-service-rg

# Restart the app service
az webapp restart --name vorba-file-service --resource-group vorba-file-service-rg
```

## ðŸ”„ Step 6: Continuous Deployment

### Branch Strategy
- **`main`**: Production deployments
- **`develop`**: Staging deployments
- **Feature branches**: Create pull requests to `develop`

### Environment Variables
Your app will automatically get these environment variables from Azure:
- `NODE_ENV=production`
- `AZURE_KEY_VAULT_URL=https://vorba-sand-kv-2.vault.azure.net/`
- `AZURE_STORAGE_CONNECTION_STRING=...`
- `WEBSITE_NODE_DEFAULT_VERSION=18.17.0`

## ðŸ“ˆ Step 7: Advanced Features

### 7.1 Add Environment-Specific Configurations
Create separate workflows for different environments:
- `.github/workflows/deploy-staging.yml`
- `.github/workflows/deploy-production.yml`

### 7.2 Add Security Scanning
Add security scanning to your workflow:
```yaml
- name: Run security audit
  run: npm audit --audit-level moderate
```

### 7.3 Customize Smoke Tests
The smoke tests validate these endpoints by default:
- `/health` - Must return HTTP 200
- `/` - Root endpoint
- `/api` - Swagger UI
- `/api/diagnostic/services` - Service diagnostics

To add custom endpoints, edit `test/smoke.e2e-spec.ts`:
```typescript
it('should test my custom endpoint', async () => {
  const response = await fetch(`${BASE_URL}/api/my-endpoint`);
  expect(response.status).toBe(200);
});
```

### 7.4 Test Environment Variables
The smoke tests use these environment variables:
- `API_URL` - Override the target URL (default: `http://localhost:3000`)

Example for testing against staging:
```yaml
- name: Run smoke tests against staging
  env:
    API_URL: https://vorba-file-service-staging.azurewebsites.net
  run: npm run test:smoke
```

### 7.5 Skip Tests (Emergency)
If you need to deploy without tests (not recommended):
```yaml
# Add condition to skip tests
- name: Run pre-build smoke tests
  if: github.event.inputs.skip_tests != 'true'
  run: |
    # ... test commands
```

## ðŸŽ‰ Success!

Your CI/CD pipeline is now set up! Every time you push to `main` or `develop`, your application will be automatically built, tested, and deployed to Azure.

### Quick Commands
```bash
# Run tests locally before pushing
npm run test:smoke

# Test locally
npm run start:dev

# Build locally
npm run build

# Deploy manually (if needed)
npm run build
# Then push to trigger GitHub Actions
```

### Test Commands
```bash
# Smoke tests (requires running server)
npm run test:smoke

# E2E tests (same as smoke)
npm run test:e2e

# Integration tests (requires databases)
npm run test:integration
```

### Useful URLs

**Web App (vorba-file-service-3)**:
- App Service: https://vorba-file-service-3.azurewebsites.net
- Health Check: https://vorba-file-service-3.azurewebsites.net/health
- Swagger Docs: https://vorba-file-service-3.azurewebsites.net/api

**ACI (vorba-file-service-4)**:
- Container: http://vorba-file-service-4.canadaeast.azurecontainer.io:8080
- Health Check: http://vorba-file-service-4.canadaeast.azurecontainer.io:8080/health

**Azure Portal**:
- Portal: https://portal.azure.com â†’ App Services â†’ vorba-file-service-3
- Resource Group: vorba-file-service-rg 