# CI/CD Pipeline Setup Guide

This guide will help you set up a complete CI/CD pipeline from your GitHub repository to Azure App Service.

## üéØ Overview

Your CI/CD pipeline will:
1. **Build** your NestJS application
2. **Test** the code quality and functionality
3. **Deploy** to Azure App Service
4. **Verify** the deployment with health checks

## üìã Prerequisites

- ‚úÖ Azure resources deployed (completed via `deploy.ps1`)
- ‚úÖ GitHub repository with your code
- ‚úÖ Publish profile from Azure (generated by deployment script)

## üîß Step 1: Add GitHub Secrets

### 1.1 Get the Publish Profile

The deployment script generated a file called `publish-profile-vorba-file-service.xml`. You need to add this to GitHub Secrets.

1. Open the file `publish-profile-vorba-file-service.xml` in your `file-service/scripts/` directory
2. Copy the entire content of the file

### 1.2 Add to GitHub Secrets

1. Go to your GitHub repository
2. Click **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
3. Click **New repository secret**
4. Name: `AZURE_WEBAPP_PUBLISH_PROFILE`
5. Value: Paste the entire content of the publish profile XML file
6. Click **Add secret**

## üîÑ Step 2: Choose Your Workflow

You have two workflow options:

### Option A: Simple Workflow (Recommended for starting)
- File: `.github/workflows/azure-deploy.yml`
- Basic build and deploy
- Good for getting started quickly

### Option B: Comprehensive Workflow
- File: `.github/workflows/azure-deploy-comprehensive.yml`
- Includes linting, health checks, and deployment verification
- Better for production environments

## üöÄ Step 3: Test the Pipeline

### 3.1 Manual Trigger (Optional)
1. Go to **Actions** tab in your GitHub repository
2. Select your workflow
3. Click **Run workflow**
4. Choose branch and click **Run workflow**

### 3.2 Automatic Trigger
1. Make a small change to your code
2. Commit and push to `main` or `develop` branch
3. Watch the workflow run in the **Actions** tab

## üìä Step 4: Monitor Your Deployment

### 4.1 GitHub Actions
- Go to **Actions** tab to see workflow runs
- Click on any run to see detailed logs
- Check the deployment summary at the end

### 4.2 Azure Portal
- Go to [Azure Portal](https://portal.azure.com)
- Navigate to your App Service: `vorba-file-service`
- Check **Deployment Center** for deployment history
- Monitor **Log stream** for application logs

### 4.3 Health Check
- Visit: `https://vorba-file-service.azurewebsites.net/health`
- Should return: `{"status":"ok","timestamp":"...","service":"vorba-file-service","version":"1.0.0"}`

## üîç Step 5: Troubleshooting

### Common Issues

#### 1. Build Failures
- Check Node.js version compatibility
- Verify all dependencies are in `package.json`
- Check for TypeScript compilation errors

#### 2. Deployment Failures
- Verify the publish profile secret is correct
- Check Azure App Service is running
- Ensure the app name matches: `vorba-file-service`

#### 3. Health Check Failures
- Check application logs in Azure Portal
- Verify environment variables are set correctly
- Check Key Vault access permissions

### Debug Commands

```bash
# Check Azure App Service logs
az webapp log tail --name vorba-file-service --resource-group vorba-file-service-rg

# Check deployment status
az webapp deployment list --name vorba-file-service --resource-group vorba-file-service-rg

# Restart the app service
az webapp restart --name vorba-file-service --resource-group vorba-file-service-rg
```

## üîÑ Step 6: Continuous Deployment

### Branch Strategy
- **`main`**: Production deployments
- **`develop`**: Staging deployments
- **Feature branches**: Create pull requests to `develop`

### Environment Variables
Your app will automatically get these environment variables from Azure:
- `NODE_ENV=production`
- `AZURE_KEY_VAULT_URL=https://vorba-sand-kv-2.vault.azure.net/`
- `AZURE_STORAGE_CONNECTION_STRING=...`
- `WEBSITE_NODE_DEFAULT_VERSION=18.17.0`

## üìà Step 7: Advanced Features

### 7.1 Add Environment-Specific Configurations
Create separate workflows for different environments:
- `.github/workflows/deploy-staging.yml`
- `.github/workflows/deploy-production.yml`

### 7.2 Add Security Scanning
Add security scanning to your workflow:
```yaml
- name: Run security audit
  run: npm audit --audit-level moderate
```

### 7.3 Add Performance Testing
Add performance testing after deployment:
```yaml
- name: Performance test
  run: |
    curl -w "@curl-format.txt" -o /dev/null -s "https://vorba-file-service.azurewebsites.net/health"
```

## üéâ Success!

Your CI/CD pipeline is now set up! Every time you push to `main` or `develop`, your application will be automatically built, tested, and deployed to Azure.

### Quick Commands
```bash
# Test locally
npm run start:dev

# Build locally
npm run build

# Deploy manually (if needed)
npm run build
# Then push to trigger GitHub Actions
```

### Useful URLs
- **App Service**: https://vorba-file-service.azurewebsites.net
- **Health Check**: https://vorba-file-service.azurewebsites.net/health
- **Swagger Docs**: https://vorba-file-service.azurewebsites.net/api (if configured)
- **Azure Portal**: https://portal.azure.com ‚Üí App Services ‚Üí vorba-file-service 