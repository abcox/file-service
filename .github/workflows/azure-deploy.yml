name: Deploy to Azure App Service (Comprehensive)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggers

env:
  NODE_VERSION: '22.14.0'
  AZURE_WEBAPP_NAME: 'vorba-file-service-3'
  AZURE_RESOURCE_GROUP: 'vorba-file-service-rg'
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  DEPLOY_ENV: 'production'

jobs:
  # optionally, can use job build-and-deploy: ?
  build:
    runs-on: ubuntu-latest # at the time of writing: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Build NestJS application
        run: |
          echo "=== BUILD STEP DEBUG ==="
          echo "Ubuntu version: $(lsb_release -rs)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo "Running: npm run build"
          
          # Run build with verbose output
          npm run build

      - name: Post build inspection
        run: |
          echo "=== POST-BUILD INSPECTION ==="
          echo "Build exit code: $?"
          echo "Dist directory exists: $(test -d dist && echo 'YES' || echo 'NO')"
          echo "Dist directory contents:"
          ls -la dist/ || echo "dist/ directory not- found"
          
          if [ $? -ne 0 ]; then
            echo "Build failed - exiting"
            exit 1
          else
            echo "Build successful"
          fi

            # TODO: review this step, and if is better to make it part of the build process
      - name: Copy config file to dist
        run: cp src/config/config.${{ env.DEPLOY_ENV }}.json dist/config.json

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package.json
            package-lock.json
            startup.sh
          retention-days: 10
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      # TODO: review the approach of installing dependencies in the release step
      # rather than in the build step (which becomes tar.gz - and we need to unzip)
      # as well, if node_modules is generated at the build step, we take a performance hit with large upload/download of build artifact
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install production dependencies
        run: |
          cd dist
          npm ci --only=production
      
      # TODO: review this step, and if is better to make it part of the build process
      #- name: Install Playwright browsers
      #  run: |
      #    cd dist
      #    npx playwright install chromium --with-deps
      - name: Install Playwright browsers
        run: |
          cd dist
          npx playwright install chromium
      
      - name: Copy startup script
        run: |
          cp startup.sh dist/
          chmod +x dist/startup.sh
      

      
      - name: Create release package
        run: |
          zip -r release-${{ github.run_number }}.zip .
      
      - name: Upload release
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: release-${{ github.run_number }}.zip
          retention-days: 10
          if-no-files-found: error
          #compression-level: 9 # 1-9, 9 is best compression
          
      - name: Inspect release contents  # â† Add this step
        run: |
          echo "=== POST-RELEASE INSPECTION ==="
          echo "Zip file size:"
          ls -lh release-${{ github.run_number }}.zip
          
          echo ""
          echo "Zip contents:"
          unzip -l release-${{ github.run_number }}.zip | head -20
          
          echo ""
          echo "Extract and show structure:"
          unzip -q release-${{ github.run_number }}.zip -d temp-extract
          find temp-extract -type f | head -10
          rm -rf temp-extract
          echo "=== END INSPECTION ==="

  deploy:
    runs-on: ubuntu-latest
    needs: release
    # TODO: review how 'environment' is used, and for what purpose/benefit
    #environment:
    #  name: 'production'
    #  url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download release package
        uses: actions/download-artifact@v4
        with:
          name: release-package
          path: ./

      - name: Unzip release package
        run: unzip release-${{ github.run_number }}.zip

      - name: Inspect unzipped release contents
        run: |
          echo "=== UNZIPPED RELEASE INSPECTION ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "ðŸ“ All files and directories:"
          ls -la
          echo ""
          echo "ðŸ“‚ Directory structure:"
          tree . || find . -type d | head -15
          echo ""
          echo "ðŸ“„ JavaScript files:"
          find . -name "*.js" | head -10
          echo ""
          echo "ðŸ“¦ Package files:"
          find . -name "package.json" -o -name "*.json" | head -5
          echo ""
          echo "ï¿½ï¿½ File count by type:"
          echo "JS files: $(find . -name '*.js' | wc -l)"
          echo "JSON files: $(find . -name '*.json' | wc -l)"
          echo "Total files: $(find . -type f | wc -l)"
          echo ""
          echo "ï¿½ï¿½ Key files check:"
          if [ -f "package.json" ]; then
            echo "âœ… package.json found"
            echo "   Dependencies: $(jq -r '.dependencies | keys | length' package.json 2>/dev/null || echo 'unknown')"
          else
            echo "âŒ package.json not found"
          fi
          
          if [ -f "dist/main.js" ]; then
            echo "âœ… dist/main.js found"
            echo "   Size: $(ls -lh dist/main.js | awk '{print $5}')"
          else
            echo "âŒ dist/main.js not found"
          fi
          
          if [ -d "node_modules" ]; then
            echo "âœ… node_modules found"
            echo "   Size: $(du -sh node_modules | awk '{print $1}')"
          else
            echo "âŒ node_modules not found"
          fi
          
          echo ""
          echo "=== END INSPECTION ==="

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          #slot-name: 'production'
          publish-profile: ${{ secrets.AZ_WEBAPP_PUB_PRFL__FILE_SVC_3 }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      # Post-deployment smoke tests - validates deployed app is working correctly
      - name: Post-deployment smoke tests
        run: |
          echo "ðŸ§ª Running post-deployment smoke tests..."
          DEPLOY_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          
          # Wait for deployment to be ready
          echo "â³ Waiting for deployment to be ready..."
          for i in {1..60}; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/health" || echo "000")
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "âœ… Deployment is ready (health check passed)"
              break
            fi
            echo "   Attempt $i: HTTP $HEALTH_STATUS - waiting..."
            sleep 5
          done
          
          # Run smoke tests against deployed app
          echo "ðŸ” Running smoke tests against $DEPLOY_URL"
          
          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s "$DEPLOY_URL/health")
          echo "Health: $HEALTH_RESPONSE"
          
          # Test root endpoint
          ROOT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/")
          echo "Root endpoint: HTTP $ROOT_STATUS"
          
          # Test Swagger endpoint
          SWAGGER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api")
          echo "Swagger endpoint: HTTP $SWAGGER_STATUS"
          
          # Test diagnostic endpoint
          DIAG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api/diagnostic/services")
          echo "Diagnostic endpoint: HTTP $DIAG_STATUS"
          
          # Validate results
          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "âŒ Health check failed"
            exit 1
          fi
          
          if [ "$ROOT_STATUS" != "200" ]; then
            echo "âŒ Root endpoint failed"
            exit 1
          fi
          
          echo "âœ… Post-deployment smoke tests passed!"
          echo ""
          echo "ðŸŒ Deployed URL: $DEPLOY_URL"

      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Web App Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: ${{ env.AZURE_WEBAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ env.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke Tests**: âœ… Passed" >> $GITHUB_STEP_SUMMARY