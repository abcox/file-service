name: Deploy to Azure Container Instances

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy-aci.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'
      environment:
        description: 'Environment'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

env:
  ACR_NAME: vorbaacr
  ACI_NAME: vorba-file-service-4
  RESOURCE_GROUP: vorba-file-service-rg
  IMAGE_NAME: file-service
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
  # User-assigned managed identity with pre-configured Key Vault access
  MANAGED_IDENTITY_ID: /subscriptions/236217f7-0ad4-4dd6-8553-dc4b574fd2c5/resourcegroups/vorba-file-service-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/vorba-file-service-identity
  # Client ID for DefaultAzureCredential to select the user-assigned identity
  MANAGED_IDENTITY_CLIENT_ID: 48c008c1-dd2a-4786-8ff0-26b96c48744f
  # SQL Server for database connectivity - ACI needs firewall rule
  SQL_SERVER_NAME: vorba-sql-svr-1
  # Log Analytics workspace for reliable ACI logging (ACI logs are unreliable without this!)
  LOG_ANALYTICS_WORKSPACE_NAME: vorba-file-service-logs

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}
          
      - name: Get ACR credentials
        id: acr-credentials
        run: |
          echo "username=$(az acr credential show --name ${{ env.ACR_NAME }} --query "username" --output tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" --output tsv)" >> $GITHUB_OUTPUT
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      # CRITICAL: ACI uses dynamic IPs - SQL Server firewall must allow Azure services
      - name: Configure SQL Server Firewall for ACI
        run: |
          echo "ðŸ”¥ Configuring SQL Server firewall for ACI access..."
          
          # Check if AllowAzureServices rule exists
          RULE_EXISTS=$(az sql server firewall-rule show --name "AllowAzureServices" --server ${{ env.SQL_SERVER_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --output tsv 2>/dev/null || echo "")
          
          if [ -z "$RULE_EXISTS" ]; then
            echo "Creating AllowAzureServices firewall rule..."
            az sql server firewall-rule create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --server ${{ env.SQL_SERVER_NAME }} \
              --name "AllowAzureServices" \
              --start-ip-address 0.0.0.0 \
              --end-ip-address 0.0.0.0 \
              --output none
            echo "âœ… AllowAzureServices rule created"
          else
            echo "âœ… AllowAzureServices rule already exists"
          fi
          
          # Check if ACI-Access rule exists (broader rule for dynamic ACI IPs)
          ACI_RULE_EXISTS=$(az sql server firewall-rule show --name "ACI-Access" --server ${{ env.SQL_SERVER_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --output tsv 2>/dev/null || echo "")
          
          if [ -z "$ACI_RULE_EXISTS" ]; then
            echo "Creating ACI-Access firewall rule..."
            az sql server firewall-rule create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --server ${{ env.SQL_SERVER_NAME }} \
              --name "ACI-Access" \
              --start-ip-address 0.0.0.0 \
              --end-ip-address 255.255.255.255 \
              --output none
            echo "âœ… ACI-Access rule created"
            echo "âš ï¸ Note: This allows all IPs - consider restricting in production"
          else
            echo "âœ… ACI-Access rule already exists"
          fi
      
      # CRITICAL: ACI logs are UNRELIABLE without Log Analytics - crashes lose stdout!
      - name: Setup Log Analytics for ACI Logging
        id: log-analytics
        run: |
          echo "ðŸ“Š Setting up Log Analytics for reliable ACI logging..."
          
          # Check if workspace exists
          WORKSPACE_EXISTS=$(az monitor log-analytics workspace show --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.LOG_ANALYTICS_WORKSPACE_NAME }} --output json 2>/dev/null || echo "")
          
          if [ -z "$WORKSPACE_EXISTS" ]; then
            echo "Creating Log Analytics workspace..."
            az monitor log-analytics workspace create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --workspace-name ${{ env.LOG_ANALYTICS_WORKSPACE_NAME }} \
              --location canadaeast \
              --output none
            echo "âœ… Log Analytics workspace created"
          else
            echo "âœ… Log Analytics workspace already exists"
          fi
          
          # Get workspace ID and key
          WORKSPACE_ID=$(az monitor log-analytics workspace show --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.LOG_ANALYTICS_WORKSPACE_NAME }} --query customerId --output tsv)
          WORKSPACE_KEY=$(az monitor log-analytics workspace get-shared-keys --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.LOG_ANALYTICS_WORKSPACE_NAME }} --query primarySharedKey --output tsv)
          
          echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT
          echo "::add-mask::$WORKSPACE_KEY"
          echo "workspace_key=$WORKSPACE_KEY" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Workspace ID: $WORKSPACE_ID"
          echo "ðŸ“‹ Query logs with: ContainerInstanceLog_CL | where ContainerGroup_s == '${{ env.ACI_NAME }}'"
          
      - name: Deploy to Azure Container Instances
        run: |
          # Check if ACI exists
          ACI_EXISTS=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --output json 2>/dev/null | jq -r '.name // empty')
          
          if [ -n "$ACI_EXISTS" ]; then
            echo "Deleting existing ACI instance (required for config changes)..."
            az container delete --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --yes
            sleep 10
          fi
          
          echo "Creating ACI instance with Log Analytics logging..."
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username ${{ steps.acr-credentials.outputs.username }} \
            --registry-password ${{ steps.acr-credentials.outputs.password }} \
            --dns-name-label ${{ env.ACI_NAME }} \
            --os-type Linux \
            --ports 8080 \
            --cpu 2 \
            --memory 4 \
            --restart-policy OnFailure \
            --assign-identity ${{ env.MANAGED_IDENTITY_ID }} \
            --log-analytics-workspace ${{ steps.log-analytics.outputs.workspace_id }} \
            --log-analytics-workspace-key ${{ steps.log-analytics.outputs.workspace_key }} \
            --environment-variables \
              NODE_ENV=${{ github.event.inputs.environment || 'production' }} \
              PORT=8080 \
              PLAYWRIGHT_BROWSER_PATH=/ms-playwright/chromium-*/chrome-linux/chrome \
              DEBUG_STARTUP=true \
              AZURE_CLIENT_ID=${{ env.MANAGED_IDENTITY_CLIENT_ID }} \
            --output none
          
      - name: Verify Managed Identity
        run: |
           echo "âœ… Using user-assigned managed identity: vorba-file-service-identity"
           echo "   This identity has pre-configured Key Vault access."
           echo "   No role assignment needed on each deployment."
          
      
          
      - name: Wait for ACI to be ready
        run: |
           echo "Waiting for ACI to be ready..."
           sleep 30  # Give ACI time to provision
          
      - name: Get ACI status
        id: aci-status
        run: |
          ACI_STATUS=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "provisioningState" --output tsv)
          echo "ACI Status: $ACI_STATUS"
          
          if [ "$ACI_STATUS" = "Succeeded" ]; then
            echo "âœ… ACI deployment successful!"
            
            # Get the FQDN
            FQDN=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "ipAddress.fqdn" --output tsv)
            echo "ðŸŒ ACI URL: http://$FQDN:8080"
            echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          else
            echo "âŒ ACI deployment failed with status: $ACI_STATUS"
            exit 1
          fi

      # Post-deployment smoke tests - validates deployed container is working correctly
      - name: Post-deployment smoke tests
        run: |
          echo "ðŸ§ª Running post-deployment smoke tests..."
          DEPLOY_URL="http://${{ steps.aci-status.outputs.fqdn }}:8080"
          
          # Wait for container to fully start
          echo "â³ Waiting for container to be ready..."
          for i in {1..60}; do
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/health" --max-time 10 || echo "000")
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "âœ… Container is ready (health check passed)"
              break
            fi
            echo "   Attempt $i: HTTP $HEALTH_STATUS - waiting..."
            sleep 5
          done
          
          # Run smoke tests against deployed container
          echo "ðŸ” Running smoke tests against $DEPLOY_URL"
          
          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s "$DEPLOY_URL/health" --max-time 10 || echo "failed")
          echo "Health: $HEALTH_RESPONSE"
          
          # Test root endpoint
          ROOT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/" --max-time 10 || echo "000")
          echo "Root endpoint: HTTP $ROOT_STATUS"
          
          # Test Swagger endpoint
          SWAGGER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api" --max-time 10 || echo "000")
          echo "Swagger endpoint: HTTP $SWAGGER_STATUS"
          
          # Test diagnostic endpoint
          DIAG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/api/diagnostic/services" --max-time 10 || echo "000")
          echo "Diagnostic endpoint: HTTP $DIAG_STATUS"
          
          # Validate results
          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "âŒ Health check failed (HTTP $HEALTH_STATUS)"
            exit 1
          fi
          
          if [ "$ROOT_STATUS" != "200" ]; then
            echo "âš ï¸ Root endpoint returned HTTP $ROOT_STATUS (may be expected)"
          fi
          
          echo "âœ… Post-deployment smoke tests passed!"
          echo ""
          echo "ðŸŒ Deployed URL: $DEPLOY_URL"
          
      - name: Show ACI logs
        if: always()
        run: |
           echo "ðŸ“‹ Recent ACI logs (from az container logs):"
           az container logs --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} || echo "No logs available from az container logs"
           
           echo ""
           echo "ðŸ“Š Querying Log Analytics for comprehensive logs..."
           echo "   (Log Analytics captures logs even if container crashes!)"
           
           # Wait for logs to be ingested
           sleep 30
           
           # Install log-analytics extension if needed
           az extension add --name log-analytics --yes 2>/dev/null || true
           
           # Query Log Analytics
           az monitor log-analytics query \
             --workspace ${{ steps.log-analytics.outputs.workspace_id }} \
             --analytics-query "ContainerInstanceLog_CL | where ContainerGroup_s == '${{ env.ACI_NAME }}' | order by TimeGenerated desc | take 50 | project TimeGenerated, Message" \
             --output table 2>/dev/null || echo "Log Analytics query failed or no logs yet (may take a few minutes to ingest)"
           
           echo ""
           echo "ðŸ”§ Container Status:"
           az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "{state:containers[0].instanceView.currentState.state,exitCode:containers[0].instanceView.currentState.exitCode,restartCount:containers[0].instanceView.restartCount}" --output table
          
      - name: Post deployment info
        if: success()
        run: |
          FQDN=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "ipAddress.fqdn" --output tsv)
          echo "## ðŸš€ ACI Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ACI Name**: ${{ env.ACI_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://$FQDN:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke Tests**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Log Analytics" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ env.LOG_ANALYTICS_WORKSPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Query logs**: \`ContainerInstanceLog_CL | where ContainerGroup_s == '${{ env.ACI_NAME }}'\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "- ACI has no free tier - you pay per second of runtime" >> $GITHUB_STEP_SUMMARY
          echo "- ACI uses managed identity for Key Vault access" >> $GITHUB_STEP_SUMMARY
          echo "- SQL Server firewall is configured to allow ACI dynamic IPs" >> $GITHUB_STEP_SUMMARY
          echo "- Log Analytics captures logs even if container crashes (ACI native logs are unreliable!)" >> $GITHUB_STEP_SUMMARY
          echo "- Stop ACI after testing: \`az container stop --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
