name: Deploy to Azure Container Instances

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - 'Dockerfile'
      - '.github/workflows/azure-deploy-aci.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'
      environment:
        description: 'Environment'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

env:
  ACR_NAME: vorbaacr
  ACI_NAME: vorba-file-service-4
  RESOURCE_GROUP: vorba-file-service-rg
  IMAGE_NAME: file-service
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
  # User-assigned managed identity with pre-configured Key Vault access
  MANAGED_IDENTITY_ID: /subscriptions/236217f7-0ad4-4dd6-8553-dc4b574fd2c5/resourcegroups/vorba-file-service-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/vorba-file-service-identity
  # Client ID for DefaultAzureCredential to select the user-assigned identity
  MANAGED_IDENTITY_CLIENT_ID: 48c008c1-dd2a-4786-8ff0-26b96c48744f

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}
          
      - name: Get ACR credentials
        id: acr-credentials
        run: |
          echo "username=$(az acr credential show --name ${{ env.ACR_NAME }} --query "username" --output tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" --output tsv)" >> $GITHUB_OUTPUT
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          
      - name: Deploy to Azure Container Instances
        run: |
          # Check if ACI exists
          ACI_EXISTS=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --output json 2>/dev/null | jq -r '.name // empty')
          
          if [ -n "$ACI_EXISTS" ]; then
            echo "Updating existing ACI instance..."
            az container create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.ACI_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
              --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ steps.acr-credentials.outputs.username }} \
              --registry-password ${{ steps.acr-credentials.outputs.password }} \
              --dns-name-label ${{ env.ACI_NAME }} \
              --os-type Linux \
              --ports 3000 \
              --cpu 2 \
              --memory 4 \
              --restart-policy Always \
              --assign-identity ${{ env.MANAGED_IDENTITY_ID }} \
              --environment-variables \
                NODE_ENV=${{ github.event.inputs.environment || 'production' }} \
                PORT=3000 \
                PLAYWRIGHT_BROWSER_PATH=/ms-playwright/chromium-*/chrome-linux/chrome \
                DEBUG_STARTUP=true \
                AZURE_CLIENT_ID=${{ env.MANAGED_IDENTITY_CLIENT_ID }} \
              --output none
          else
            echo "Creating new ACI instance..."
            az container create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name ${{ env.ACI_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
              --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ steps.acr-credentials.outputs.username }} \
              --registry-password ${{ steps.acr-credentials.outputs.password }} \
              --dns-name-label ${{ env.ACI_NAME }} \
              --os-type Linux \
              --ports 3000 \
              --cpu 2 \
              --memory 4 \
              --restart-policy Always \
              --assign-identity ${{ env.MANAGED_IDENTITY_ID }} \
              --environment-variables \
                NODE_ENV=${{ github.event.inputs.environment || 'production' }} \
                PORT=3000 \
                PLAYWRIGHT_BROWSER_PATH=/ms-playwright/chromium-*/chrome-linux/chrome \
                DEBUG_STARTUP=true \
                AZURE_CLIENT_ID=${{ env.MANAGED_IDENTITY_CLIENT_ID }} \
              --output none
          fi
          
      - name: Verify Managed Identity
        run: |
           echo "âœ… Using user-assigned managed identity: vorba-file-service-identity"
           echo "   This identity has pre-configured Key Vault access."
           echo "   No role assignment needed on each deployment."
          
      
          
      - name: Wait for ACI to be ready
        run: |
           echo "Waiting for ACI to be ready..."
           sleep 30  # Give ACI time to provision
          
      - name: Get ACI status
        run: |
          ACI_STATUS=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "provisioningState" --output tsv)
          echo "ACI Status: $ACI_STATUS"
          
          if [ "$ACI_STATUS" = "Succeeded" ]; then
            echo "âœ… ACI deployment successful!"
            
            # Get the FQDN
            FQDN=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "ipAddress.fqdn" --output tsv)
            echo "ðŸŒ ACI URL: http://$FQDN:3000"
            
            # Test health endpoint
            echo "ðŸ¥ Testing health endpoint..."
            sleep 30  # Wait for container to fully start
            
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://$FQDN:3000/health" || echo "000")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "âœ… Health check passed!"
            else
              echo "âš ï¸ Health check failed (HTTP $HEALTH_RESPONSE)"
            fi
          else
            echo "âŒ ACI deployment failed with status: $ACI_STATUS"
            exit 1
          fi
          
      - name: Show ACI logs
        if: always()
        run: |
           echo "ðŸ“‹ Recent ACI logs:"
           az container logs --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
           
           echo ""
           echo "ðŸ” Waiting for debug diagnostics to complete..."
           sleep 60  # Wait for debug diagnostics to run
           
           echo "ðŸ“Š Debug Diagnostics Output:"
           az container logs --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --tail 100
           
           echo ""
           echo "ðŸ”§ Container Status:"
           az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "{state:containers[0].instanceView.state,restartCount:containers[0].instanceView.restartCount,detailStatus:containers[0].instanceView.detailStatus}" --output table
          
      - name: Post deployment info
        if: success()
        run: |
          FQDN=$(az container show --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "ipAddress.fqdn" --output tsv)
          echo "## ðŸš€ ACI Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ACI Name**: ${{ env.ACI_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://$FQDN:3000" >> $GITHUB_STEP_SUMMARY
                           echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
                           echo "### âš ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
                 echo "- ACI has no free tier - you pay per second of runtime" >> $GITHUB_STEP_SUMMARY
                 echo "- ACI uses managed identity for Key Vault access (no secrets in environment variables)" >> $GITHUB_STEP_SUMMARY
                 echo "- Remember to stop ACI after testing: \`az container stop --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
                 echo "- Use \`az container logs --name ${{ env.ACI_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}\` to view logs" >> $GITHUB_STEP_SUMMARY
